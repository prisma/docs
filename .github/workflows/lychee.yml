name: Lychee

on: [pull_request]

jobs:
  lychee:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Lychee Link Checker
        uses: lycheeverse/lychee-action@v2
        with:
          fail: true
          args: >
            --verbose
            --no-progress
            --accept 200,201,204,304,403,429
            --timeout 20
            --max-retries 3
            --max-concurrency 16
            --exclude 'http://localhost.*'
            --exclude 'https://localhost.*'
            --exclude '^/.*'
            --exclude 'https://dev.mysql.com/.*'
            --exclude 'https://www.mysql.com/.*'
            --exclude 'https://www.npmjs.com/.*'
            --exclude 'https://openai.com/.*'
            --exclude 'https://platform.openai.com/.*'
            --exclude 'https://dash.cloudflare.com/.*'
            --exclude 'https://playground.ai.cloudflare.com/.*'
            --exclude 'https://www.cockroachlabs.com/blog/.*'
            --exclude-mail
            './**/*.md' './**/*.mdx' './**/*.html'
          workingDirectory: "content"
        env:
          GITHUB_TOKEN: ${{ secrets.github_token }}

      - name: Comment Broken Links
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          path: lychee/out.md
