---
title: 'Data Migration with Expand and Contract Pattern'
metaTitle: 'Data Migration with Expand and Contract Pattern | Prisma Guide'
metaDescription: 'Learn how to perform data migrations using the expand and contract pattern with Prisma ORM'
image: '/img/guides/data-migration-cover.png'
tags:
  - migration
  - data-migration
  - schema
  - database
  - prisma-migrate
  - production
  - postgresql
  - expand-and-contract
  - schema-evolution
  - best-practices
  - git
  - deployment
  - ci-cd
---

## Introduction

This guide demonstrates how to migrate data between columns using the expand and contract pattern with Prisma ORM. We'll walk through replacing a boolean field with an enum field while preserving existing data.

## Prerequisites

- A PostgreSQL database
- Prisma ORM project setup with existing schema
- Access to both development and production databases
- Basic understanding of Git branching

## Step 1: Initial Schema Setup

Start with a basic schema containing a Post model:

```prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Post {
  id        Int     @id @default(autoincrement())
  title     String
  content   String?
  published Boolean @default(false)
}
```

## Step 2: Expand Schema with New Column

1. Create a new branch:

```bash
git checkout -b create-status-field
```

2. Update your schema to add the new Status enum and field:

```prisma
model Post {
  id        Int      @id @default(autoincrement())
  title     String
  content   String?
  published Boolean? @default(false)
  status    Status   @default(Unknown)
}

enum Status {
  Unknown
  Draft
  InProgress
  InReview
  Published
}
```

3. Generate the migration:

```bash
npx prisma migrate dev --name add-status-column
```

## Step 3: Create Data Migration Script

1. Create a new TypeScript file for the data migration:

```typescript
import { PrismaClient } from '@prisma/client'

const prisma = new PrismaClient()

async function main() {
  await prisma.$transaction(async (tx) => {
    const posts = await tx.post.findMany()
    for (const post of posts) {
      await tx.post.update({
        where: { id: post.id },
        data: {
          status: post.published ? 'Published' : 'Unknown',
        },
      })
    }
  })
}

main()
  .catch(async (e) => {
    console.error(e)
    process.exit(1)
  })
  .finally(async () => await prisma.$disconnect())
```

2. Add the migration script to your package.json:

```json
{
  "scripts": {
    "data-migration:add-status-column": "tsx ./prisma/migrations/<migration-timestamp>/data-migration.ts"
  }
}
```

## Step 4: Run the Migration

1. Update your DATABASE_URL to point to the production database
2. Run the migration script:

```bash
npm run data-migration:add-status-column
```

## Step 5: Contract Schema by Removing Old Column

1. Create a new branch:

```bash
git checkout -b drop-published-column
```

2. Update your schema to remove the published field:

```prisma
model Post {
  id      Int      @id @default(autoincrement())
  title   String
  content String?
  status  Status   @default(Unknown)
}

enum Status {
  Draft
  InProgress
  InReview
  Published
}
```

3. Generate and run the migration:

```bash
npx prisma migrate dev --name drop-published-column
```

## Step 6: Deploy to Production

Add the following command to your CI/CD pipeline:

```bash
npx prisma migrate deploy
```

## Troubleshooting

### Common Issues

1. **Migration Fails Due to Missing Default**: If adding a required field fails, ensure you've added a proper default value.
2. **Data Loss Prevention**: Always backup your database before running migrations in production.
3. **Transaction Rollback**: If the data migration fails, the transaction will automatically rollback, allowing you to fix and retry.

## Next Steps

- Learn more about [Prisma Migrate](/orm/prisma-migrate)
- Explore [schema prototyping](/orm/prisma-migrate/workflows/prototyping-your-schema)
- Understand [customizing migrations](/orm/prisma-migrate/workflows/customizing-migrations)

## Additional Resources

- [Expand and Contract Pattern Documentation](https://www.prisma.io/dataguide/types/relational/expand-and-contract-pattern)
- [Prisma Migrate Workflows](/orm/prisma-migrate/workflows)
