---
title: 'Deploy to AWS Lambda with Serverless Framework'
metaTitle: 'Deploy your Serverless Framework project with Prisma'
metaDescription: 'Learn how to deploy your Prisma-backed applications to AWS Lambda with Serverless Framework'
tocDepth: 3
---

<TopBlock>

This guide explains how to avoid common issues when deploying a project using Prisma with [Serverless Framework](https://www.serverless.com/framework/).

While Prisma works well with the Serverless Framework "out of the box", there are a few improvements that can be made within your project to ensure a smooth deployment and performance. There is also additional configuration that is needed if you are using the [`serverless-webpack`](https://www.npmjs.com/package/serverless-webpack) or [`serverless-bundle`](https://www.npmjs.com/package/serverless-bundle) libraries.

</TopBlock>

## Prerequisites

This guide assumes you have an existing project using both Serverless Framework and Prisma. For a guide on how to get started with Serverless Framework, we recommend [Setting Up Serverless Framework With AWS](https://www.serverless.com/framework/docs/getting-started).

## Binary targets in <inlinecode>schema.prisma</inlinecode>

The Prisma schema should contain the following in the `generator` block:

```prisma
binaryTargets = ["native", "rhel-openssl-1.0.x"]
```

This is necessary because the local runtime is different from the Lambda runtime. Add the [`binaryTarget`](/reference/api-reference/prisma-schema-reference#binarytargets-options) to make the compatible Prisma engine file available.

### Lambda functions with arm64 architectures

Lambda functions that use [arm64 architectures (AWS Graviton2 processor)](https://docs.aws.amazon.com/lambda/latest/dg/foundation-arch.html#foundation-arch-adv) must use an `arm64` precompiled engine file.

In the `generator` block of your `schema.prisma` file, add the following:

```prisma file=schema.prisma
binaryTargets = ["native", "linux-arm64-openssl-1.0.x"]
```

Update the Serverless configuration file to package the `arm64` engine file, as follows:

```code file=serverless.yml
package:
  patterns:
    - '!node_modules/.prisma/client/libquery_engine-*'
    - 'node_modules/.prisma/client/libquery_engine-linux-arm64-*'
    - '!node_modules/prisma/libquery_engine-*'
    - '!node_modules/@prisma/engines/**'
```

## Loading environment variables via a <inlinecode>.env</inlinecode> file

Your functions will need the `DATABASE_URL` environment variable to access the database. The `serverless-dotenv-plugin` will allow you to use your `.env` file in your deployments.

First, make sure that the plugin is installed

```sh
npm install -D serverless-dotenv-plugin
```

Then, add `serverless-dotenv-plugin` to your list of plugins in `serverless.yml`

```code file=serverless.yml no-copy
plugins:
  - serverless-dotenv-plugin
```

No further configuration needed! Your environment variables defined in your `.env` file will now be loaded on package or deployment.

```sh no-copy highlight=3-4;normal
❯ serverless package
Running "serverless" from node_modules
DOTENV: Loading environment variables from .env:
         - DATABASE_URL

Packaging deployment-example-sls for stage dev (us-east-1)
.
.
.
```

## Connection pooling

Generally, when you use a FaaS (Function as a Service) environment to interact with a database, every function invocation can result in a new connection to the database. This is not a problem with a constantly running node.js server. Therefore, it is beneficial to pool DB connections to get better performance. You can use the [Data Proxy](/data-platform/data-proxy) as a solution to this issue. For other solutions, see the [connection management guide for serverless environments](/guides/performance-and-optimization/connection-management#serverless-environments-faas).

## Deploy only the required files

To reduce your deployment footprint, you can change your deployment process so that you only upload the files that your application needs. The Serverless configuration file `serverless.yml` below show a `package` pattern that includes only the Prisma engine file relevant to the Lambda runtime, and excludes the others. This means that when Serverless Framework packages your app for upload, it includes only one engine file. This ensures the packaged archive is as small as possible.

```code file=serverless.yml no-copy
package:
  patterns:
    - '!node_modules/.prisma/client/libquery_engine-*'
    - 'node_modules/.prisma/client/libquery_engine-rhel-*'
    - '!node_modules/prisma/libquery_engine-*'
    - '!node_modules/@prisma/engines/**'
```

However, if you use `serverless-webpack`, then you cannot use this method. See [Deployment with serverless webpack](#deployment-with-serverless-webpack) below.

## Deployment with <inlinecode>serverless-webpack</inlinecode>

If you use `serverless-webpack`, then you will need additional configuration so that your `schema.prisma` is properly bundled. You will need to:

1. Copy your `schema.prisma` with [`copy-webpack-plugin`](https://www.npmjs.com/package/copy-webpack-plugin).
2. Run `prisma generate` via `custom > webpack > packagerOptions > scripts` in your `serverless.yml`
3. Only package the correct Prisma engine file. This can save more than 40mb of capacity.

Let's get started!

### Install webpack specific dependencies

First, make sure all required webpack dependencies are installed:

```sh
npm install -D webpack webpack-node-externals copy-webpack-plugin serverless-webpack
```

### Update <inlinecode>webpack.config.js</inlinecode>

In your `webpack.config.js` make sure that you set `externals` to node externals like the following:

```javascript file=webpack.config.js
const nodeExternals = require('webpack-node-externals')

module.exports = {
  // ... other configuration
  externals: [nodeExternals()],
  // ... other configuration
}
```

Your `webpack.config.js` will also need a `plugins` property. This will allow `copy-webpack-plugin` to copy your `schema.prisma` file into your bundled code.

Building on our example above, we get:

```javascript file=webpack.config.js
const nodeExternals = require('webpack-node-externals')
const CopyPlugin = require('copy-webpack-plugin')

module.exports = {
  // ... other configuration
  externals: [nodeExternals()],
  plugins: [
    new CopyPlugin({
      patterns: [
        { from: './node_modules/.prisma/client/schema.prisma', to: './' }, // you may need to change `to` here.
      ],
    }),
  ],
  // ... other configuration
}
```

<Admonition>

Depending on how your application is bundled, you may need to copy the schema file to a location other than `./`. Use the `serverless package` command to package your code locally so you can review where your schema should be put.

</Admonition>

Refer to the [Serverless Webpack documentation](https://www.serverless.com/plugins/serverless-webpack) for additional configuration.

### Update <inlinecode>serverless.yml</inlinecode>

In `serverless.yml` make sure that the `custom > webpack` block has `prisma generate` under `packagerOptions > scripts` as follows:

```yaml file=serverless.yml
custom:
  webpack:
    packagerOptions:
      scripts:
        - prisma generate
```

Lastly, you will want to exclude [Prisma query engines](https://www.prisma.io/docs/concepts/components/prisma-engines/query-engine) that do not match the AWS Lambda runtime. Taking our `serverless.yml` example above, you can add the following to make sure that all query engines are removed except for the `rhel-openssl-1.0.x` one.

```yaml file=serverless.yml highlight=6;add
custom:
  webpack:
    packagerOptions:
      scripts:
        - prisma generate
        - find . -name "libquery_engine-*" -not -name "libquery_engine-rhel-openssl-*" | xargs rm
```

If instead you are deploying to [Lambda functions with ARM64 architecture](#lambda-functions-with-arm64-architectures) you should update the find command to the following:

```sh
find . -name "libquery_engine-*" -not -name "libquery_engine-arm64-openssl-*" | xargs rm
```

## Wrapping up

You can now re-package and re-deploy your application. To do so, run `serverless deploy`. Webpack output will show the schema file being moved with `copy-webpack-plugin`

```sh no-copy highlight=9;normal
❯ serverless package
Running "serverless" from node_modules
DOTENV: Loading environment variables from .env:
         - DATABASE_URL

Packaging deployment-example-sls for stage dev (us-east-1)

asset handlers/posts.js 713 bytes [emitted] [minimized] (name: handlers/posts)
  asset schema.prisma 293 bytes [emitted] [from: node_modules/.prisma/client/schema.prisma] [copied]
  ./handlers/posts.ts 745 bytes [built] [code generated]
  external "@prisma/client" 42 bytes [built] [code generated]
  webpack 5.88.2 compiled successfully in 685 ms
Package lock found - Using locked versions
Packing external modules: @prisma/client@^5.1.1

✔ Service packaged (5s)
```

## Summary

You have successfully deployed a Prisma-backed Serverless Framework application. Congratulations!
